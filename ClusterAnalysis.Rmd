---
title: "R Notebook"
output: html_notebook
---

**1. Load necessary libraries**

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(GGally)
library(knitr)
library(ggplot2)
library(dplyr)
library(corrr)
library(MASS)
library(corrgram)

```



```{r}
Cluster <- read.csv("clusteringData.csv", 
                   header = T, stringsAsFactors = F)
kable(head(Cluster))
sapply(Cluster, class)
```

```{r}
#get rid of percent sign
Cluster$Positive_Profitability = as.numeric(gsub("\\%", "", Cluster$Positive_Profitability))
Cluster$Profitability = as.numeric(gsub("\\%", "", Cluster$Profitability))
#Verify no percent sign
kable(head(Cluster) %>% arrange(Profitability)) 
#convert profitability and positive profitability to numeric
Cluster$Positive_Profitability <- as.numeric(Cluster$Positive_Profitability)
Cluster$Profitability <- as.numeric(Cluster$Profitability)

#if need to convert them to integer
# Cluster$Profitability <- as.integer(Cluster$Profitability)
# Cluster$Positive_Profitability <- as.integer(Cluster$Positive_Profitability)
Cluster$Account_Open_Date <- as.Date(Cluster$Account_Open_Date , format = "%m/%d/%Y")
#verify class change
sapply(Cluster, class)
kable(head(Cluster)) 
```
```{r}
summary(Cluster)
```


```{r}
set.seed(121)
sampleSet <- sample_n(Cluster, 1000)
str(sampleSet)
head(sampleSet)
ggplot(sampleSet, aes(x = Profitability, y = Card_Fees_Amt)) + geom_point(alpha = 0.1, color = "blue")+ geom_smooth(method = "lm")
ggplot(sampleSet, aes(x = Profitability, y = Card_Fees_Amt)) + geom_point() + scale_x_log10() + scale_y_log10() + geom_smooth(method = "lm")


ggplot(sampleSet, aes(x = Positive_Profitability, y = Card_Fees_Amt, color = factor(Average_Risk_Grade))) + geom_point(alpha = 0.3)

ggplot(sampleSet, aes(x = Positive_Profitability, y = Card_Fees_Amt, color = factor(Average_Risk_Grade))) + geom_point(alpha = 0.3) + facet_wrap(~ Average_Risk_Grade)


```


```{r}
newdata = sampleSet[,c(3:4, 5:18)]
plot(newdata, pch=16, col="blue", main="Matrix Scatterplot of ...")

mod1 = lm(Positive_Profitability ~ Average_Gallons_Card + Net_Late_Fee_Count +Net_Profit_Card + Years_on_Books + Card_Fees_Amt +No_Accounts_by_Customer + Rebate_Amt + Average_Risk_Grade + Gross_Revenue_Amt+ Purchase_Gallons_Qty, data=sampleSet)
summary(mod1)
```

```{r}
names(newdata)
```
```{r}
mod2 = lm(Positive_Profitability ~ Average_Gallons_Card + Max_of_Cards + Net_Late_Fee_Count + Total_Expense_Amt + Net_Profit + Net_Profit_Card + Years_on_Books + Card_Fees_Amt + No_Accounts_by_Customer + Rebate_Amt + Average_Risk_Grade + Gross_Revenue_Amt+ Purchase_Gallons_Qty + Acquisition_Cost, data=sampleSet)
summary(mod2)

```


```{r}
mod3 <- lm(Positive_Profitability ~ Average_Gallons_Card + Max_of_Cards + Total_Expense_Amt + Net_Profit_Card + Years_on_Books + Purchase_Gallons_Qty + Acquisition_Cost, data = sampleSet)
summary(mod3)
```

```{r}
library(dplyr)
head(sampleSet)
dim(sampleSet)
names(sampleSet)
sampleSet <- sampleSet[, -c(1:3, 5, 7, 9, 11:13, 17:19 )]
dim(sampleSet)
head(sampleSet)

head(Cluster)

Cluster1 <- Cluster %>% dplyr::select(Positive_Profitability, Average_Risk_Grade, Average_Gallons_Card, Max_of_Cards, Total_Expense_Amt, Net_Profit_Card, Years_on_Books, Purchase_Gallons_Qty, Acquisition_Cost)
#Sig Variables 56%
c1 <- lm(Positive_Profitability ~  Average_Gallons_Card+ Max_of_Cards + Total_Expense_Amt + Net_Profit_Card + Years_on_Books + Purchase_Gallons_Qty + Acquisition_Cost, data = Cluster1)
summary(c1)

#Removed acquiaition 49%
c2 <- lm(Positive_Profitability ~ Average_Gallons_Card+ Max_of_Cards + Total_Expense_Amt + Net_Profit_Card + Years_on_Books + Purchase_Gallons_Qty, data = Cluster1)
summary(c2)

#removed acquisition and Purchase gallons 43%
c3 <- lm(Positive_Profitability ~ Average_Gallons_Card+ Max_of_Cards + Total_Expense_Amt + Net_Profit_Card + Years_on_Books, data = Cluster1)
summary(c3)

#removed acquisition and Purchase gallons, Years_on_Books 40%
c4<- lm(Positive_Profitability ~ Average_Gallons_Card+ Max_of_Cards + Total_Expense_Amt + Net_Profit_Card, data = Cluster1)
summary(c4)

#removed acquisition and Purchase gallons, Years_on_Books, NetProfit_Card 33%
c4<- lm(Positive_Profitability ~ Average_Gallons_Card+ Max_of_Cards + Total_Expense_Amt,  data = Cluster1)
summary(c4)

#removed acquisition and Purchase gallons, Years_on_Books, NetProfit_Card .02%
c4<- lm(Positive_Profitability ~ Average_Gallons_Card+ Max_of_Cards,  data = Cluster1)
summary(c4)

#Net Profit Card 
c4<- lm(Positive_Profitability ~  Net_Profit_Card,  data = Cluster1)
summary(c4)

#Net Profit Card 
c4<- lm(Positive_Profitability ~  Average_Gallons_Card ,  data = Cluster1)
summary(c4)

#Max_Cards 
c4<- lm(Positive_Profitability ~  Max_of_Cards,  data = Cluster1)
summary(c4)


#Max_Cards 
c4<- lm(Positive_Profitability ~  Years_on_Books,  data = Cluster1)
summary(c4)

#Purchase_Gallons_Qty 
c4<- lm(Positive_Profitability ~ Purchase_Gallons_Qty,  data = Cluster1)
summary(c4)

#Acquisition_Cost 
c4<- lm(Positive_Profitability ~ Acquisition_Cost,  data = Cluster1)
summary(c4)




head(Cluster1)
summary(Cluster1)
set.seed(201)
cluster1Smple <- sample_n(Cluster1, 1000) %>% na.omit()
summary(cluster1Smple)
head(cluster1Smple)
kc <- kmeans(cluster1Smple[, 3:9], 4, nstart = 20)
kc$centers
kc$size

table(kc$cluster, cluster1Smple$Average_Risk_Grade)
kc$cluster <- as.factor(kc$cluster)

ggplot(cluster1Smple, aes(Total_Expense_Amt, Years_on_Books, color = kc$cluster, alpha = 0.1)) + geom_point()

ggplot(cluster1Smple, aes(Max_of_Cards, Total_Expense_Amt, color = kc$cluster, alpha = 0.5)) + geom_point()
```



```{r}
head(iris)
dim(iris)
set.seed(20)
irisCluster <- kmeans(iris[, 3:4], 3, nstart = 20)
irisCluster
```
```{r}

ggcorr(Cluster1, label = T)
corrgram(as.matrix(Cluster1), order = NULL, panel = panel.shade, text.panel = panel.txt, main = "Correlogram")
```




```{r, echo=TRUE}

fit <- lm(Profitability ~  Net_Late_Fee_Count + Acquisition_Cost + Net_Profit +  Years_on_Books +  Average_Risk_Grade, data=Cluster)
summary(fit) # show results
Cluster <- Cluster %>% dplyr::select(Random, Customer_Index, Profitability, Net_Late_Fee_Count, Acquisition_Cost, Net_Profit, Years_on_Books)
Cluster <- as.matrix(Cluster)
head(Cluster)


```




```{r}
library(reshape2)
Long <- melt(sampleSet, id= c("Random", "Customer_Index"))
Long[8000, ]
head(newdata)
ggplot(newdata, aes(x = Positive_Profitability, y = Max_of_Cards )) + geom_point() + geom_smooth(method = "lm")
                      #,color = factor(Years_on_Books
                                     
ggplot(newdata, aes(x = Positive_Profitability, y = Gross_Revenue_Amt )) + geom_point() + geom_smooth(method = "lm")

ggplot(newdata, aes(y = Positive_Profitability, x = Card_Fees_Amt )) + geom_point() + geom_smooth(method = "lm")

```


